<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-WEI-AI é»æ­Œç³»çµ±</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkEtV0VJLUFJIOu7nuatjOezu+eyçµ±IiwKICAic2hvcnRfbmFtZSI6ICJBLVdFSS1BSSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGYxNzJhIiwKICAidGhlbWVfY29sb3I6ICIjMGVhNWU5IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsaXRpY29uLmNvbS81MTIvMzI5My8zMjkzODQ0LnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ==">
    <meta name="theme-color" content="#0ea5e9">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: #f8fafc;
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .btn-gradient { background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4); }
        
        .favorite-active { color: #f43f5e !important; fill: #f43f5e; filter: drop-shadow(0 0 5px rgba(244, 63, 94, 0.6)); }

        input:focus, select:focus {
            outline: none;
            border-color: #38bdf8 !important;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
        }

        .tag-lang-tw { background: rgba(56, 189, 248, 0.15); color: #38bdf8; border: 1px solid rgba(56, 189, 248, 0.3); }
        .tag-lang-kr { background: rgba(168, 85, 247, 0.15); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.3); }
        .tag-karaoke { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
        
        #player-ui { transition: transform 0.4s ease-in-out; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 pb-40">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-10 text-center">
            <h1 class="text-4xl md:text-6xl font-black mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 via-indigo-400 to-purple-500 tracking-tight">
                A-WEI-AI é»æ­Œç³»çµ±
            </h1>
            <p class="text-slate-400 max-w-2xl mx-auto text-sm md:text-base mb-6">
                å°ˆæ¥­éŸ³æ¨‚é»æ­Œç®¡ç†ç³»çµ±ã€‚æ”¯æ´æˆ‘çš„æœ€æ„›é€£çºŒæ’­æ”¾èˆ‡é›²ç«¯å‚™ä»½åŠŸèƒ½ã€‚
            </p>
            
            <div class="flex flex-wrap justify-center gap-3">
                <button onclick="manualSave()" class="bg-emerald-600 hover:bg-emerald-500 px-6 py-2 rounded-full font-bold text-white shadow-lg flex items-center gap-2 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    æ‰‹å‹•å­˜æª”
                </button>
                <button onclick="startPlaylist()" class="bg-rose-600 hover:bg-rose-500 px-6 py-2 rounded-full font-bold text-white shadow-xl flex items-center gap-2 transition-all group">
                    <svg class="w-5 h-5 group-hover:animate-pulse" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                    æ’­æ”¾æ”¶è—æ¸…å–®
                </button>
                <div class="flex gap-2">
                    <button onclick="exportData()" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-full text-slate-300" title="åŒ¯å‡ºå‚™ä»½">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    </button>
                    <label class="bg-slate-800 hover:bg-slate-700 p-2 rounded-full text-slate-300 cursor-pointer" title="åŒ¯å…¥è³‡æ–™">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
                    </label>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Sidebar: Form -->
            <div class="lg:col-span-4 xl:col-span-3">
                <div class="glass-card p-6 rounded-3xl sticky top-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="formTitle" class="text-xl font-bold text-sky-400">æ–°å¢æ­Œæ›²</h2>
                        <button id="cancelEdit" onclick="resetForm()" class="hidden text-xs text-slate-400 hover:text-white underline">å–æ¶ˆç·¨è¼¯</button>
                    </div>
                    <div class="space-y-4 text-sm">
                        <input type="hidden" id="editIndex" value="-1">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-slate-500 block mb-1">ç·¨è™Ÿ</label>
                                <input type="text" id="songId" placeholder="No." class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 text-white">
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 block mb-1">é¡åˆ¥</label>
                                <select id="songCategory" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 text-slate-300">
                                    <option value="æ­Œæ›²">æ­Œæ›²</option>
                                    <option value="ä¼´å”±">ä¼´å”±</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">æ­Œå</label>
                            <input type="text" id="songTitle" placeholder="è¼¸å…¥æ­Œæ›²åç¨±" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 text-white font-bold">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">ä½œè©è€… / å‚™è¨»</label>
                            <input type="text" id="songLyricist" placeholder="ä¾‹å¦‚ï¼šä½œæ›²å®¶æˆ–æ¼”å”±ç­†è¨˜" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 text-white">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-slate-500 block mb-1">æ€§åˆ¥</label>
                                <select id="songGender" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 text-slate-300">
                                    <option value="ç”·ç”Ÿ">ç”·ç”Ÿ</option>
                                    <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
                                    <option value="åˆå”±">åˆå”±</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 block mb-1">èªè¨€</label>
                                <select id="songLang" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 text-slate-300">
                                    <option value="å°èª">å°èª</option>
                                    <option value="åœ‹èª">åœ‹èª</option>
                                    <option value="éŸ“èª">éŸ“èª</option>
                                    <option value="è‹±èª">è‹±èª</option>
                                    <option value="æ—¥èª">æ—¥èª</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">YouTube é€£çµ</label>
                            <input type="url" id="songUrl" placeholder="è²¼ä¸Šç¶²å€æˆ– ID" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 text-white">
                        </div>
                        <button onclick="saveSong()" id="saveBtn" class="w-full btn-gradient py-3 rounded-xl font-bold text-white shadow-lg mt-2">
                            å„²å­˜æ­Œæ›²
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content: Search & List -->
            <div class="lg:col-span-8 xl:col-span-9">
                <!-- Toolbar -->
                <div class="glass-card p-4 rounded-3xl mb-6 space-y-4">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="relative flex-grow">
                            <svg class="w-5 h-5 absolute left-3 top-2.5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="text" id="searchInput" oninput="renderSongs()" placeholder="æœå°‹æ­Œåã€ä½œè©è€…..." class="w-full bg-slate-900/40 border border-slate-700 rounded-2xl pl-10 pr-4 py-2 text-sm">
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <select onchange="renderSongs()" id="filterCategory" class="bg-slate-800/50 border border-slate-700 rounded-xl px-3 py-2 text-xs text-slate-300">
                                <option value="å…¨éƒ¨é¡åˆ¥">å…¨éƒ¨é¡åˆ¥</option>
                                <option value="æ­Œæ›²">æ­Œæ›²</option>
                                <option value="ä¼´å”±">ä¼´å”±</option>
                            </select>
                            <select onchange="renderSongs()" id="filterLang" class="bg-slate-800/50 border border-slate-700 rounded-xl px-3 py-2 text-xs text-slate-300">
                                <option value="å…¨éƒ¨èªè¨€">å…¨éƒ¨èªè¨€</option>
                                <option value="å°èª">å°èª</option>
                                <option value="åœ‹èª">åœ‹èª</option>
                                <option value="éŸ“èª">éŸ“èª</option>
                                <option value="è‹±èª">è‹±èª</option>
                                <option value="æ—¥èª">æ—¥èª</option>
                            </select>
                            <label class="flex items-center gap-2 px-3 py-2 bg-slate-800/50 rounded-xl border border-slate-700 cursor-pointer text-xs">
                                <input type="checkbox" id="filterFav" onchange="renderSongs()" class="rounded text-rose-500 bg-slate-900 border-slate-700">
                                <span class="text-slate-400">åƒ…æ”¶è—</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="glass-card rounded-3xl overflow-hidden shadow-2xl">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-left border-collapse min-w-[800px]">
                            <thead>
                                <tr class="bg-slate-800/80 text-[10px] tracking-widest uppercase text-slate-500">
                                    <th class="px-6 py-4 font-bold w-12 text-center">æ”¶è—</th>
                                    <th class="px-6 py-4 font-bold">æ­Œæ›²è³‡è¨Š</th>
                                    <th class="px-6 py-4 font-bold">å±¬æ€§æ¨™ç±¤</th>
                                    <th class="px-6 py-4 font-bold text-right">ç®¡ç†</th>
                                </tr>
                            </thead>
                            <tbody id="songList" class="divide-y divide-slate-700/30"></tbody>
                        </table>
                    </div>
                    <div id="emptyState" class="hidden text-center py-32 text-slate-500">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 19V6l12-3v13M9 19c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zM21 16c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2z"></path></svg>
                        æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ­Œæ›²ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Bottom Player -->
    <div id="player-ui" class="fixed bottom-0 left-0 w-full bg-slate-900/95 border-t border-white/10 p-4 transform translate-y-full z-50 backdrop-blur-xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
        <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-12 gap-6 items-center">
            <!-- Video Container -->
            <div class="md:col-span-3 lg:col-span-2 aspect-video bg-black rounded-xl overflow-hidden shadow-inner shrink-0 relative">
                <div id="player" class="absolute inset-0"></div>
            </div>
            
            <!-- Metadata -->
            <div class="md:col-span-5 lg:col-span-7 flex flex-col justify-center overflow-hidden">
                <div class="flex items-center gap-2 mb-1">
                    <span id="p-category" class="text-[10px] font-bold px-2 py-0.5 bg-sky-500/20 text-sky-400 rounded-full border border-sky-500/30 uppercase">æ­Œæ›²</span>
                    <span id="p-lang" class="text-[10px] font-bold px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded-full border border-purple-500/30 uppercase">å°èª</span>
                </div>
                <h3 id="p-title" class="text-xl font-black text-white truncate drop-shadow-sm">æ’­æ”¾ä¸­...</h3>
                <p id="p-sub" class="text-sm text-slate-400 truncate">è«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹é€£çºŒæ’­æ”¾</p>
            </div>

            <!-- Controls -->
            <div class="md:col-span-4 lg:col-span-3 flex items-center justify-end gap-2">
                <button onclick="toggleShuffle()" id="shuffleBtn" class="p-2 text-slate-500 hover:text-white transition-colors" title="éš¨æ©Ÿæ’­æ”¾">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16M4 20h16M4 12l4-4m0 0l4 4m-4-4v12M20 12l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </button>
                <div class="flex items-center bg-slate-800/50 rounded-2xl p-1 gap-1">
                    <button onclick="playPrev()" class="p-2 text-slate-300 hover:text-white">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14v-2.798l5.445 3.63A1 1 0 0017 14V6a1 1 0 00-1.555-.832L10 8.798V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z"></path></svg>
                    </button>
                    <button onclick="closePlayer()" class="p-3 bg-rose-600 rounded-xl text-white hover:bg-rose-500 shadow-lg transition-transform active:scale-95">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <button onclick="playNext()" class="p-2 text-slate-300 hover:text-white">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M4.555 14.832A1 1 0 006 14v-2.798l5.445 3.63A1 1 0 0013 14V6a1 1 0 00-1.555-.832L6 8.798V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z" transform="rotate(180 10 10)"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 right-10 bg-sky-600 text-white px-8 py-4 rounded-2xl shadow-2xl transform translate-y-32 transition-transform duration-500 z-[100] font-bold border border-white/20"></div>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- è³‡æ–™ç®¡ç† ---
        let songs = JSON.parse(localStorage.getItem('a-wei-v3')) || [
            {
    "id": "250319-1",
    "title": "çƒ½ç«ä¸‰åœ‹",
    "lyricist": "A-WEI",
    "gender": "ç”·ç”Ÿ",
    "lang": "åœ‹èª",
    "category": "æ­Œæ›²",
    "url": "https://youtu.be/-p7aKMy1_Ag",
    "favorite": false
  },
  {
    "id": "250318-3",
    "title": "æˆ€æˆ€æˆ€",
    "lyricist": "A-WEI",
    "gender": "å¥³ç”Ÿ",
    "lang": "åœ‹èª",
    "category": "æ­Œæ›²",
    "url": "https://youtu.be/Vptl08c52as",
    "favorite": false
  },
  {
    "id": "250318-2",
    "title": "èªªå¥½ä¸æ•£",
    "lyricist": "A-WEI",
    "gender": "å¥³ç”Ÿ",
    "lang": "åœ‹èª",
    "category": "æ­Œæ›²",
    "url": "https://youtu.be/rXc2HmOGl2c",
    "favorite": false
  },
  {
    "id": "250318-1",
    "title": "æ°¸é çš„ç¯ç«",
    "lyricist": "A-WEI",
    "gender": "å¥³ç”Ÿ",
    "lang": "æ—¥èª",
    "category": "æ­Œæ›²",
    "url": "https://youtu.be/b6-OeCYbJ3M",
    "favorite": false
  },
  {
    "id": "250317-2",
    "title": "åˆ¥å†å›é ­",
    "lyricist": "A-WEI",
    "gender": "å¥³ç”Ÿ",
    "lang": "åœ‹èª",
    "category": "æ­Œæ›²",
    "url": "https://youtu.be/Mv9RnyqU-MM",
    "favorite": false
  },
  {
    "id": "250317-1",
    "title": "å±ç«",
    "lyricist": "A-WEI",
    "gender": "å¥³ç”Ÿ",
    "lang": "åœ‹èª",
    "category": "æ­Œæ›²",
    "url": "https://youtu.be/qwHH8G64e78",
    "favorite": false
  },
  {
    "id": "250316-3",
    "title": "åˆ†æ‰‹çš„é‚£ä¸€å¤©",
    "lyricist": "A-WEI",
    "gender": "å¥³ç”Ÿ",
    "lang": "åœ‹èª",
    "category": "æ­Œæ›²",
    "url": "https://youtu.be/z_AB-cbrVJ4",
    "favorite": false
  },
  {
    "id": "250316-2",
    "title": "å¿ƒé–é›£é–‹",
    "lyricist": "A-WEI",
    "gender": "å¥³ç”Ÿ",
    "lang": "åœ‹èª",
    "category": "æ­Œæ›²",
    "url": "https://youtu.be/I03M7QkHeks",
    "favorite": false
  },
  {
    "id": "250316-1",
    "title": "ä»–ä¸æ˜",
    "lyricist": "A-WEI",
    "gender": "å¥³ç”Ÿ",
    "lang": "åœ‹èª",
    "category": "æ­Œæ›²",
    "url": "https://youtu.be/rl_seu7ttAc",
    "favorite": false
  }


        ];

        let player;
        let playlist = [];
        let curIdx = 0;
        let isShuffle = false;
        let isPlayerReady = false;

        // --- æ’­æ”¾é‚è¼¯ ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1, 'playsinline': 1 },
                events: { 
                    'onReady': onPlayerReady,
                    'onStateChange': (e) => { if(e.data === YT.PlayerState.ENDED) playNext(); } 
                }
            });
        }

        function onPlayerReady() {
            isPlayerReady = true;
        }

        // å„ªåŒ–å¾Œçš„ YouTube ID æå–å™¨
        function extractId(url) {
            const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regExp);
            if (match && match[1]) {
                return match[1];
            }
            // å¦‚æœæ­£å‰‡æ²’æŠ“åˆ°ï¼Œå˜—è©¦ç›´æ¥æ¸…ç†å­—ä¸²
            return url.trim();
        }

        function startPlaylist() {
            playlist = songs.filter(s => s.favorite);
            if(playlist.length === 0) return alert('æ”¶è—æ¸…å–®æ˜¯ç©ºçš„ï¼è«‹é»æ“Šæ­Œåæ—çš„ã€Œæ„›å¿ƒã€æ”¶è—æ­Œæ›²ã€‚');
            
            if(isShuffle) {
                playlist = [...playlist].sort(() => Math.random() - 0.5);
            }
            
            curIdx = 0;
            document.getElementById('player-ui').classList.remove('translate-y-full');
            loadSong();
        }

        function playSingle(idx) {
            playlist = [songs[idx]];
            curIdx = 0;
            document.getElementById('player-ui').classList.remove('translate-y-full');
            loadSong();
        }

        function loadSong() {
            if (!isPlayerReady || !player) {
                setTimeout(loadSong, 500);
                return;
            }
            
            const s = playlist[curIdx];
            const vid = extractId(s.url);
            
            if (vid) {
                player.loadVideoById(vid);
                document.getElementById('p-title').innerText = s.title;
                document.getElementById('p-sub').innerText = `No.${s.id} â€¢ ä½œè©ï¼š${s.lyricist}`;
                document.getElementById('p-category').innerText = s.category;
                document.getElementById('p-lang').innerText = s.lang;
            } else {
                showToast('âŒ ç„¡æ•ˆçš„ YouTube é€£çµ');
                if (playlist.length > 1) playNext();
            }
        }

        function playNext() { 
            if (playlist.length === 0) return;
            curIdx = (curIdx + 1) % playlist.length; 
            loadSong(); 
        }
        
        function playPrev() { 
            if (playlist.length === 0) return;
            curIdx = (curIdx - 1 + playlist.length) % playlist.length; 
            loadSong(); 
        }
        
        function closePlayer() { 
            if (player) player.stopVideo(); 
            document.getElementById('player-ui').classList.add('translate-y-full'); 
        }
        
        function toggleShuffle() {
            isShuffle = !isShuffle;
            document.getElementById('shuffleBtn').classList.toggle('text-sky-400', isShuffle);
            showToast(isShuffle ? 'ğŸ”€ éš¨æ©Ÿæ’­æ”¾ï¼šé–‹å•Ÿ' : 'ğŸ” éš¨æ©Ÿæ’­æ”¾ï¼šé—œé–‰');
            // å¦‚æœæ­£åœ¨æ’­æ”¾æ”¶è—æ¸…å–®ï¼Œæ›´æ–°å‰©ä¸‹çš„æ’­æ”¾åº
            if (playlist.length > 1) {
                const currentSong = playlist[curIdx];
                playlist = songs.filter(s => s.favorite);
                if (isShuffle) playlist = playlist.sort(() => Math.random() - 0.5);
                curIdx = playlist.findIndex(s => s.id === currentSong.id);
                if (curIdx === -1) curIdx = 0;
            }
        }

        // --- è¡¨å–®åŠŸèƒ½ ---
        function saveSong() {
            const id = document.getElementById('songId').value.trim();
            const title = document.getElementById('songTitle').value.trim();
            const lyricist = document.getElementById('songLyricist').value.trim() || 'æœªå¡«å¯«';
            const gender = document.getElementById('songGender').value;
            const lang = document.getElementById('songLang').value;
            const category = document.getElementById('songCategory').value;
            const url = document.getElementById('songUrl').value.trim();
            const editIdx = parseInt(document.getElementById('editIndex').value);

            if(!id || !title || !url) return alert('è«‹å¡«å¯«ç·¨è™Ÿã€æ­Œåèˆ‡ç¶²å€');

            const data = { 
                id, 
                title, 
                lyricist, 
                gender, 
                lang, 
                category, 
                url, 
                favorite: editIdx >= 0 ? (songs[editIdx].favorite || false) : false 
            };

            if(editIdx >= 0) {
                songs[editIdx] = data;
                showToast('âœ… æ­Œæ›²å·²æ›´æ–°ï¼');
            } else {
                songs.unshift(data);
                showToast('âœ… æ­Œæ›²å·²æ–°å¢ï¼');
            }

            autoSave();
            resetForm();
            renderSongs();
        }

        function editSong(originalIndex) {
            const s = songs[originalIndex];
            document.getElementById('songId').value = s.id;
            document.getElementById('songTitle').value = s.title;
            document.getElementById('songLyricist').value = s.lyricist;
            document.getElementById('songGender').value = s.gender;
            document.getElementById('songLang').value = s.lang;
            document.getElementById('songCategory').value = s.category;
            document.getElementById('songUrl').value = s.url;
            document.getElementById('editIndex').value = originalIndex;
            
            document.getElementById('formTitle').innerText = 'ç·¨è¼¯æ­Œæ›²';
            document.getElementById('saveBtn').innerText = 'æ›´æ–°è³‡æ–™';
            document.getElementById('cancelEdit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('editIndex').value = "-1";
            document.getElementById('formTitle').innerText = 'æ–°å¢æ­Œæ›²';
            document.getElementById('saveBtn').innerText = 'å„²å­˜æ­Œæ›²';
            document.getElementById('cancelEdit').classList.add('hidden');
            ['songId', 'songTitle', 'songLyricist', 'songUrl'].forEach(id => document.getElementById(id).value = '');
        }

        function deleteSong(idx) {
            const confirmBox = confirm('ç¢ºå®šåˆªé™¤é€™é¦–æ­Œå—ï¼Ÿ');
            if(confirmBox) {
                songs.splice(idx, 1);
                autoSave(); renderSongs();
                showToast('ğŸ—‘ï¸ æ­Œæ›²å·²åˆªé™¤ã€‚');
            }
        }

        function toggleFav(idx) {
            songs[idx].favorite = !songs[idx].favorite;
            autoSave(); renderSongs();
        }

        // --- UI æ¸²æŸ“ ---
        function renderSongs() {
            const list = document.getElementById('songList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const fCat = document.getElementById('filterCategory').value;
            const fLang = document.getElementById('filterLang').value;
            const fFav = document.getElementById('filterFav').checked;
            
            list.innerHTML = '';

            const filtered = songs.map((s, i) => ({...s, oriIdx: i})).filter(s => {
                const matchSearch = s.title.toLowerCase().includes(search) || s.lyricist.toLowerCase().includes(search) || s.id.includes(search);
                const matchCat = fCat === 'å…¨éƒ¨é¡åˆ¥' || s.category === fCat;
                const matchLang = fLang === 'å…¨éƒ¨èªè¨€' || s.lang === fLang;
                const matchFav = !fFav || s.favorite;
                return matchSearch && matchCat && matchLang && matchFav;
            });

            filtered.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/[0.03] transition-colors group text-sm';
                tr.innerHTML = `
                    <td class="px-6 py-4 text-center">
                        <button onclick="toggleFav(${s.oriIdx})" class="transition-all hover:scale-125 focus:outline-none">
                            <svg class="w-6 h-6 ${s.favorite ? 'favorite-active' : 'text-slate-700'}" fill="currentColor" viewBox="0 0 20 20"><path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/></svg>
                        </button>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-[10px] font-bold text-sky-500 mb-0.5 tracking-tighter">#${s.id}</div>
                        <div class="text-white font-bold text-lg leading-tight">${s.title}</div>
                        <div class="text-slate-500 text-xs mt-1">ä½œè©ï¼š${s.lyricist}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-2">
                            <span class="px-2 py-0.5 text-[10px] font-bold rounded-full ${s.category === 'ä¼´å”±' ? 'tag-karaoke' : 'bg-indigo-500/10 text-indigo-400 border border-indigo-500/20'}">${s.category}</span>
                            <span class="px-2 py-0.5 text-[10px] font-bold rounded-full ${s.lang === 'å°èª' ? 'tag-lang-tw' : (s.lang === 'éŸ“èª' ? 'tag-lang-kr' : 'bg-slate-800 text-slate-400 border border-slate-700')}">${s.lang}</span>
                            <span class="px-2 py-0.5 text-[10px] font-bold rounded-full bg-slate-800 text-slate-500 border border-slate-700">${s.gender}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="playSingle(${s.oriIdx})" class="p-2 bg-sky-500/10 text-sky-400 rounded-xl hover:bg-sky-500/20 transition-all shadow-sm" title="å³æ™‚æ’­æ”¾">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                            </button>
                            <button onclick="editSong(${s.oriIdx})" class="p-2 text-slate-400 hover:text-white transition-colors" title="ç·¨è¼¯å…§å®¹">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button onclick="deleteSong(${s.oriIdx})" class="p-2 text-slate-600 hover:text-rose-400 transition-colors" title="åˆªé™¤æ­Œæ›²">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </td>
                `;
                list.appendChild(tr);
            });

            document.getElementById('emptyState').classList.toggle('hidden', filtered.length > 0);
        }

        // --- ç³»çµ±å·¥å…· ---
        function autoSave() { localStorage.setItem('a-wei-v3', JSON.stringify(songs)); }
        
        function manualSave() { 
            autoSave(); 
            showToast('ğŸ’¾ è³‡æ–™å·²æˆåŠŸå„²å­˜è‡³æ­¤è£ç½®ï¼'); 
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 3000);
        }
        
        function exportData() {
            const blob = new Blob([JSON.stringify(songs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'a-wei-backup-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            showToast('ğŸ“¤ å·²åŒ¯å‡ºå‚™ä»½æª”æ¡ˆã€‚');
        }
        
        function importData(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    if(Array.isArray(data)) {
                        songs = data; 
                        autoSave(); 
                        renderSongs(); 
                        showToast('ğŸ“¥ è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                    }
                } catch(err) { alert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦ç‚º JSONã€‚'); }
            };
            reader.readAsText(file);
        }

        // --- PWA è¨»å†Š ---
        if('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const sw = `self.addEventListener('install', e => self.skipWaiting()); self.addEventListener('fetch', e => e.respondWith(fetch(e.request)));`;
                const blob = new Blob([sw], { type: 'text/javascript' });
                navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
            });
        }

        window.onload = renderSongs;
    </script>
</body>
</html>